# OAuth2/OpenID Connect 認可サーバー プロジェクト

## プロジェクト概要

このプロジェクトは、OAuth2およびOpenID Connectプロトコルをゼロから実装する教育用の認可サーバーです。

### 技術スタック

- **PHP**: 8.3.x（最新安定版）
- **フレームワーク**: CakePHP 5.x
- **データベース**: PostgreSQL
- **テスト**: PHPUnit
- **コード品質**: PHPStan (level 9), PHP_CodeSniffer (PSR-12)

### 学習目標

- PHPの深い理解（外部OAuthライブラリを使わずに実装）
- OAuth2/OpenID Connectプロトコルの根本的な理解
- TDD実践とTidy First原則の適用
- セキュアなコーディングプラクティス

---

## 開発ワークフロー

### 1. 開発ガイドラインに従う

**すべての開発は `docs/DEVELOPMENT_GUIDE.md` を参考に進めること。**

特に以下の点を厳守：
- TDD（Red-Green-Refactor）サイクル
- Tidy First原則（構造変更と動作変更の分離）
- コミット規律（テスト通過時のみコミット）
- セキュリティガイドライン

### 2. 実装前に設計を行う

**新機能や大きな変更を実装する前に、必ず設計フェーズを経ること。**

#### 設計プロセス

1. **要件の明確化**
   - 実装する機能の目的と要件を明確にする
   - OAuth2/OpenID Connect仕様のどの部分を実装するか特定

2. **設計ドキュメントの作成**
   - 設計内容を `docs/design/` ディレクトリに記録
   - ファイル名形式：`YYYYMMDD-<feature-name>.md`
   - 例：`20241024-authorization-code-flow.md`

3. **設計ドキュメントに含めるべき内容**
   - 機能概要
   - アーキテクチャ図（必要に応じて）
   - クラス設計（主要なクラス、インターフェース）
   - データベーススキーマ（新規テーブルや変更）
   - API仕様（エンドポイント、リクエスト/レスポンス）
   - セキュリティ考慮事項
   - テスト方針

4. **設計のレビュー**
   - 設計ドキュメントを見直し、SOLID原則に従っているか確認
   - セキュリティリスクがないか確認

### 3. 実装ログをドキュメント化

**実装した内容は整理してドキュメントに記録し、開発ログとして蓄積すること。**

#### 実装ログの管理

1. **実装ログの保存場所**
   - `docs/implementation-log/` ディレクトリ
   - ファイル名形式：`YYYYMMDD-<feature-name>-implementation.md`
   - 例：`20241024-authorization-code-flow-implementation.md`

2. **実装ログに含めるべき内容**
   - 実装日時
   - 実装した機能の概要
   - 実装したクラス/メソッドのリスト（ファイルパスと行番号）
   - 重要な実装の決定事項と理由
   - 発生した問題と解決方法
   - テストカバレッジ
   - 関連するコミットハッシュ

3. **実装ログのテンプレート**
   ```markdown
   # [機能名] 実装ログ

   ## 実装日
   YYYY-MM-DD

   ## 概要
   [何を実装したか]

   ## 実装内容

   ### 追加したファイル
   - src/Service/OAuth2/Example.php
   - tests/TestCase/Service/OAuth2/ExampleTest.php

   ### 変更したファイル
   - src/Controller/OAuth2/TokenController.php:45-67

   ## 実装の決定事項
   - [重要な設計判断とその理由]

   ## 発生した問題と解決
   - [問題]: [説明]
   - [解決]: [説明]

   ## テスト
   - カバレッジ: XX%
   - テスト数: XX個

   ## 関連コミット
   - abc1234: "Feature: ..."
   - def5678: "Tidy: ..."

   ## 参照した仕様
   - RFC 6749 Section X.X
   ```

### 4. 機能変更時のログ更新

**機能の変更や修正を行ったら、対応する実装ログも更新すること。**

#### 更新プロセス

1. 変更する機能の実装ログを特定
2. 実装ログに「更新履歴」セクションを追加または更新
3. 変更内容、理由、影響範囲を記録

#### 更新履歴の形式

```markdown
## 更新履歴

### YYYY-MM-DD: [変更内容の概要]
- **変更理由**: [なぜ変更したか]
- **変更内容**: [何を変更したか]
- **影響範囲**: [どのファイル、どの機能に影響するか]
- **関連コミット**: abc1234
```

### 5. 既存機能変更時のログ参照

**既存機能の変更を行う前に、対応する実装ログを必ず確認すること。**

#### 確認プロセス

1. **実装ログの検索**
   - `docs/implementation-log/` ディレクトリから関連するログを探す
   - 機能名、クラス名、ファイル名で検索

2. **実装背景の理解**
   - なぜその実装になったのか
   - どのような設計判断があったのか
   - 過去にどのような問題があったか

3. **変更の影響評価**
   - 変更が他の機能に影響しないか確認
   - テストが網羅しているか確認

4. **変更の記録**
   - 実装ログに更新履歴を追加
   - 必要に応じて設計ドキュメントも更新

### 6. PROGRESS.mdの更新（必須）

**実装が完了したら、必ず `docs/PROGRESS.md` を更新すること。**

#### 更新タイミング

以下のタイミングで**必ず**更新：

1. **機能実装完了時**
   - Entity/Table実装が完了し、すべてのテストが通った時
   - タスクのチェックボックスを更新
   - 実装の詳細を「完了したマイルストーン」セクションに追加

2. **フェーズの進捗変更時**
   - フェーズのステータスを更新（未開始 → 進行中 → 完了）
   - 完了した機能数をカウント

3. **マイルストーン達成時**
   - 日付セクションを追加
   - 達成した内容を箇条書きで記録

#### 更新内容チェックリスト

- [ ] タスクのチェックボックス状態を更新
- [ ] フェーズステータスを更新
- [ ] 「完了したマイルストーン」セクションに詳細を追加
- [ ] テスト数や実装したクラスを記録
- [ ] 「次のステップ」セクションを更新
- [ ] 「最終更新」日付を更新

#### 更新例

```markdown
### 2025-10-27

#### Client/Scope実装完了
- ✅ Client Entity実装（11テスト、全成功）
- ✅ ClientsTable実装（11テスト、全成功）
- ✅ Scope Entity実装
- ✅ ScopesTable実装
- ✅ テストフィクスチャ作成
```

**PROGRESS.md更新を忘れると、プロジェクトの進捗が追跡できなくなります。**

---

## プロジェクト固有の実装方針

### OAuth2/OpenID Connect実装

**外部ライブラリを使わず、すべて手動実装する。**

これは学習目的であり、以下を深く理解するため：
- トークンの生成と検証
- 暗号化とハッシュ化
- セキュリティベストプラクティス
- プロトコルフロー

### 実装フェーズ

1. **フェーズ1: 基盤** - クライアント管理、ユーザー認証、スコープ管理
2. **フェーズ2: 認可コードフロー** - 認可エンドポイント、トークン発行
3. **フェーズ3: トークン管理** - リフレッシュトークン、取り消し
4. **フェーズ4: OpenID Connect** - IDトークン、UserInfo、Discovery
5. **フェーズ5: 追加フロー** - Client Credentials、PKCE、動的登録

**現在のフェーズは常に `docs/PROGRESS.md` で管理する。**

### セキュリティ重視

認可サーバーは高価値のターゲット。セキュリティは最優先事項。

- トークン、パスワード、シークレットをログに記録しない
- 暗号学的に安全な乱数生成を使用
- 定数時間比較を使用
- すべての入力を検証
- レート制限の実装

### CakePHP規約

- ビジネスロジックはServiceレイヤーに配置
- Controllerは薄く保つ
- 依存性注入を活用
- CakePHPの規約に従う（命名、ディレクトリ構造など）

---

## ドキュメント構造

```
docs/
├── DEVELOPMENT_GUIDE.md          # 開発ガイドライン（マスタードキュメント）
├── PROGRESS.md                   # プロジェクト進捗状況
├── design/                       # 設計ドキュメント
│   └── YYYYMMDD-feature-name.md
├── implementation-log/           # 実装ログ
│   └── YYYYMMDD-feature-name-implementation.md
├── architecture/                 # アーキテクチャドキュメント
│   └── overview.md
└── api/                          # API仕様書
    └── oauth2-endpoints.md
```

---

## コマンドリファレンス

### 開発開始時

```bash
# テスト実行
vendor/bin/phpunit

# 静的解析
vendor/bin/phpstan analyse src tests --level=9

# コードスタイルチェック
vendor/bin/phpcs src tests --standard=PSR12
```

### データベース

```bash
# マイグレーション作成
bin/cake bake migration CreateTableName

# マイグレーション実行
bin/cake migrations migrate

# マイグレーションロールバック
bin/cake migrations rollback
```

### テスト

```bash
# すべてのテスト
vendor/bin/phpunit

# カバレッジ付き
vendor/bin/phpunit --coverage-html coverage/

# 特定のテスト
vendor/bin/phpunit tests/TestCase/Service/OAuth2/TokenGeneratorTest.php
```

---

## 開発時の注意事項

### 常に意識すること

1. **テストファースト**: コードを書く前にテストを書く
2. **小さなステップ**: 一度に1つの小さな機能を実装
3. **頻繁なコミット**: グリーンの状態で頻繁にコミット
4. **ドキュメント更新**: コードと同時にドキュメントを更新
   - **特にPROGRESS.mdは実装完了時に必ず更新**
   - 実装ログも忘れずに記録
5. **セキュリティ**: すべての実装でセキュリティを考慮

### やってはいけないこと

1. テストなしでコードを書く
2. 構造変更と動作変更を同じコミットに含める
3. テストが失敗している状態でコミット
4. 機密情報をログに出力
5. 将来の要件を予測した過度な抽象化

---

## 参照すべきリソース

### 仕様書（手元に置いておく）

- [RFC 6749 - OAuth 2.0](https://tools.ietf.org/html/rfc6749)
- [RFC 7636 - PKCE](https://tools.ietf.org/html/rfc7636)
- [OpenID Connect Core 1.0](https://openid.net/specs/openid-connect-core-1_0.html)

### 開発ガイド

- `docs/DEVELOPMENT_GUIDE.md` - このプロジェクトの開発ガイドライン
- グローバルCLAUDE.md - TDDとTidy First原則

---

## このファイルについて

このファイルは**プロジェクト固有のClaude Code指示書**です。

- グローバルCLAUDE.md（TDD、Tidy First原則）と併せて参照される
- プロジェクトの進化に伴い、このファイルも更新する
- すべての開発者（人間とAI）がこの方針に従う

**最終更新**: 2025-10-27
